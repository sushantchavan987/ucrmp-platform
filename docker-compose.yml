services:

  # --- 1. Discovery Service (The "Phone Book") ---
  discovery-service:
    build:
      context: ./backend/discovery-service # Path to its Dockerfile
    container_name: discovery-service
    ports:
      - "8761:8761" # Map host port 8761 to container port 8761
    environment:
      - SPRING_APPLICATION_NAME=discovery-service
    networks:
      - ucrmp-net

  # --- 2. Auth Database (MySQL) ---
  auth-db:
    image: mysql:8.0 # Use the official MySQL 8.0 image
    container_name: auth-db
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - MYSQL_DATABASE=${AUTH_DB_NAME}
    ports:
      - "3308:3306" # <-- FIXED! Host port 3308 -> Container port 3306
    volumes:
      - auth-db-data:/var/lib/mysql
    networks:
      - ucrmp-net
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      timeout: 10s
      retries: 10

  # --- 3. Claim Database (MySQL) ---
  claim-db:
    image: mysql:8.0
    container_name: claim-db
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - MYSQL_DATABASE=${CLAIM_DB_NAME}
    ports:
      - "3309:3306" # <-- FIXED! Host port 3309 -> Container port 3306
    volumes:
      - claim-db-data:/var/lib/mysql
    networks:
      - ucrmp-net
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      timeout: 10s
      retries: 10

  # --- 4. Auth Service ---
  auth-service:
    build:
      context: ./backend/auth-service
    container_name: auth-service
    ports:
      - "8081:8081"
    environment:
      # Inject variables from our .env file!
      - SPRING_APPLICATION_NAME=auth-service
      - AUTH_DB_HOST=${AUTH_DB_HOST}
      - AUTH_DB_NAME=${AUTH_DB_NAME}
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - DISCOVERY_HOST=${DISCOVERY_HOST}
      - JWT_SECRET=${JWT_SECRET}
      - INITIAL_ADMIN_EMAIL=${INITIAL_ADMIN_EMAIL}
      - INITIAL_ADMIN_PASSWORD=${INITIAL_ADMIN_PASSWORD}
    networks:
      - ucrmp-net
    depends_on:
      auth-db:
        condition: service_healthy # Wait for auth-db to be healthy
      discovery-service:
        condition: service_started # Wait for discovery-service to start

  # --- 5. Claim Service ---
  claim-service:
    build:
      context: ./backend/claim-service
    container_name: claim-service
    ports:
      - "8082:8082"
    environment:
      - SPRING_APPLICATION_NAME=claim-service
      - CLAIM_DB_HOST=${CLAIM_DB_HOST}
      - CLAIM_DB_NAME=${CLAIM_DB_NAME}
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - DISCOVERY_HOST=${DISCOVERY_HOST}
      - JWT_SECRET=${JWT_SECRET}
    networks:
      - ucrmp-net
    depends_on:
      claim-db:
        condition: service_healthy
      discovery-service:
        condition: service_started

  # --- 6. API Gateway (The "Front Door") ---
  api-gateway:
    build:
      context: ./backend/api-gateway
    container_name: api-gateway
    ports:
      - "8080:8080" # This is the main port for our frontend
    environment:
      - SPRING_APPLICATION_NAME=api-gateway
      - DISCOVERY_HOST=${DISCOVERY_HOST}
      - JWT_SECRET=${JWT_SECRET}
    networks:
      - ucrmp-net
    depends_on:
      - discovery-service
      - auth-service
      - claim-service

# --- Shared Network ---
# This creates a private network for all our containers
networks:
  ucrmp-net:
    driver: bridge

# --- Persistent Data ---
# This ensures our database data is saved even if we stop the containers
volumes:
  auth-db-data:
  claim-db-data: