services:
  # --- 1. DISCOVERY SERVICE (The Phone Book) ---
  discovery-service:
    build:
      context: ./backend/discovery-service
    container_name: discovery-service
    ports:
      - "8761:8761"
    environment:
      - SPRING_APPLICATION_NAME=discovery-service
    networks:
      - ucrmp-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8761/actuator/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # --- 2. DATABASES ---
  auth-db:
    image: mysql:8.0
    container_name: auth-db
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - MYSQL_DATABASE=${AUTH_DB_NAME}
    ports:
      - "3308:3306"
    volumes:
      - auth-db-data:/var/lib/mysql
    networks:
      - ucrmp-net
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      timeout: 10s
      retries: 10

  claim-db:
    image: mysql:8.0
    container_name: claim-db
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - MYSQL_DATABASE=${CLAIM_DB_NAME}
    ports:
      - "3309:3306"
    volumes:
      - claim-db-data:/var/lib/mysql
    networks:
      - ucrmp-net
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      timeout: 10s
      retries: 10

  # --- 3. BACKEND MICROSERVICES ---
  auth-service:
    build:
      context: ./backend/auth-service
    container_name: auth-service
    ports:
      - "8081:8081"
    environment:
      - SPRING_APPLICATION_NAME=auth-service
      - AUTH_DB_HOST=${AUTH_DB_HOST}
      - AUTH_DB_NAME=${AUTH_DB_NAME}
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - DISCOVERY_HOST=${DISCOVERY_HOST}
      - JWT_SECRET=${JWT_SECRET}
      - INITIAL_ADMIN_EMAIL=${INITIAL_ADMIN_EMAIL}
      - INITIAL_ADMIN_PASSWORD=${INITIAL_ADMIN_PASSWORD}
    networks:
      - ucrmp-net
    depends_on:
      auth-db:
        condition: service_healthy
      discovery-service:
        condition: service_healthy

  claim-service:
    build:
      context: ./backend/claim-service
    container_name: claim-service
    ports:
      - "8082:8082"
    environment:
      - SPRING_APPLICATION_NAME=claim-service
      - CLAIM_DB_HOST=${CLAIM_DB_HOST}
      - CLAIM_DB_NAME=${CLAIM_DB_NAME}
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - DISCOVERY_HOST=${DISCOVERY_HOST}
      - JWT_SECRET=${JWT_SECRET}
    networks:
      - ucrmp-net
    depends_on:
      claim-db:
        condition: service_healthy
      discovery-service:
        condition: service_healthy

  api-gateway:
    build:
      context: ./backend/api-gateway
    container_name: api-gateway
    ports:
      - "8090:8080"
    environment:
      - SPRING_APPLICATION_NAME=api-gateway
      - DISCOVERY_HOST=${DISCOVERY_HOST}
      - JWT_SECRET=${JWT_SECRET}
    networks:
      - ucrmp-net
    depends_on:
      discovery-service:
        condition: service_healthy
      auth-service:
        condition: service_started
      claim-service:
        condition: service_started

  # --- 4. FRONTEND (NEW!) ---

  frontend:
    build:
      context: ./frontend
      # REMOVED: args section is gone!
    container_name: ucrmp-frontend
    ports:
      - "5173:8080"
    environment:
      # âœ… RUNTIME CONFIG: This is injected into env-config.js on startup
      - VITE_API_BASE_URL=http://localhost:8090/api/v1
    networks:
      - ucrmp-net
    depends_on:
      - api-gateway

networks:
  ucrmp-net:
    driver: bridge

volumes:
  auth-db-data:
  claim-db-data:

