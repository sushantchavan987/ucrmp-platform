# Forced update to fix paths
name: UCRMP CI Pipeline

on:
  workflow_dispatch: # Allows manual button click
  push:
    branches: [ "main" ]
    paths:
      - 'backend/**'
      - 'frontend/**'

permissions:
  contents: write

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          # --- BACKEND SERVICES (Inside 'backend' folder) ---
          - service: auth
            context: ./backend/auth-service
            image: sushantc041/ucrmp-auth
          - service: claim
            context: ./backend/claim-service
            image: sushantc041/ucrmp-claim
          - service: gateway
            context: ./backend/api-gateway
            image: sushantc041/ucrmp-gateway
          - service: discovery
            context: ./backend/discovery-service
            image: sushantc041/ucrmp-discovery-service
          
          # --- FRONTEND (Inside 'frontend' folder) ---
          - service: frontend
            context: ./frontend
            image: sushantc041/ucrmp-frontend

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          fetch-depth: 2 

      - name: Check for changes
        id: changes
        run: |
          # If Manual Trigger -> Force Build
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Manual trigger. Building ${{ matrix.service }}..."
          # If Push -> Check Folder Diff
          elif git diff --quiet HEAD^ HEAD -- ${{ matrix.context }}; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No changes in ${{ matrix.service }}."
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Changes detected in ${{ matrix.service }}."
          fi

      - name: Login to Docker Hub
        if: steps.changes.outputs.changed == 'true'
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Generate Short SHA
        if: steps.changes.outputs.changed == 'true'
        id: vars
        run: echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Build and Push Docker Image
        if: steps.changes.outputs.changed == 'true'
        uses: docker/build-push-action@v4
        with:
          context: ${{ matrix.context }}
          push: true
          tags: |
            ${{ matrix.image }}:latest
            ${{ matrix.image }}:${{ steps.vars.outputs.sha_short }}

  update-helm:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          fetch-depth: 2

      - name: Generate Short SHA
        id: vars
        run: echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Update values.yaml
        run: |
          cd helm/ucrmp
          SHORT_SHA=${{ steps.vars.outputs.sha_short }}
          
          FORCE_UPDATE="false"
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
             FORCE_UPDATE="true"
          fi

          check_and_update() {
             SERVICE_NAME=$1
             FOLDER_PATH=$2
             HELM_KEY=$3
             
             # Logic: Check specific folder paths
             if [ "$FORCE_UPDATE" == "true" ] || ! git diff --quiet HEAD^ HEAD -- ../../$FOLDER_PATH; then
               echo "Updating $SERVICE_NAME tag to $SHORT_SHA"
               sed -i "s|$HELM_KEY: .*|$HELM_KEY: \"sushantc041/ucrmp-$SERVICE_NAME:$SHORT_SHA\"|g" values.yaml
             fi
          }

          # Running check against the REAL paths
          check_and_update "auth"       "backend/auth-service"      "auth"
          check_and_update "claim"      "backend/claim-service"     "claim"
          check_and_update "gateway"    "backend/api-gateway"       "gateway"
          check_and_update "discovery-service" "backend/discovery-service" "discovery"
          check_and_update "frontend"   "frontend"                  "frontend"

          cat values.yaml 

      - name: Commit and Push
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          
          if git diff --quiet helm/ucrmp/values.yaml; then
            echo "No changes to values.yaml"
          else
            git add helm/ucrmp/values.yaml
            git commit -m "chore: update image tags for ${{ steps.vars.outputs.sha_short }} [skip ci]"
            git push
          fi
