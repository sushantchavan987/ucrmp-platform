name: UCRMP CI Pipeline

on:
  workflow_dispatch: # Manual Trigger
  push:
    branches: [ "main" ]
    paths:
      - 'backend/**'
      - 'frontend/**'

permissions:
  contents: write

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - service: auth
            context: ./backend/auth-service
            image: sushantc041/ucrmp-auth
          - service: claim
            context: ./backend/claim-service
            image: sushantc041/ucrmp-claim
          - service: gateway
            context: ./backend/api-gateway
            image: sushantc041/ucrmp-gateway
          - service: discovery
            context: ./backend/discovery-service
            image: sushantc041/ucrmp-discovery-service
          - service: frontend
            context: ./frontend
            image: sushantc041/ucrmp-frontend

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          fetch-depth: 2 

      - name: Check for changes
        id: changes
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
          elif git diff --quiet HEAD^ HEAD -- ${{ matrix.context }}; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Login to Docker Hub
        if: steps.changes.outputs.changed == 'true'
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Generate Short SHA
        if: steps.changes.outputs.changed == 'true'
        id: vars
        run: echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Build and Push Docker Image
        if: steps.changes.outputs.changed == 'true'
        uses: docker/build-push-action@v4
        with:
          context: ${{ matrix.context }}
          push: true
          tags: |
            ${{ matrix.image }}:latest
            ${{ matrix.image }}:${{ steps.vars.outputs.sha_short }}

  update-helm:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # Fetch all history to ensure diff works

      - name: Update values.yaml
        run: |
          # 1. Get the SHA
          SHORT_SHA=$(git rev-parse --short HEAD)
          echo "Using SHA: $SHORT_SHA"

          # 2. Determine which services changed (Run from ROOT)
          # Default to FALSE
          UPDATE_AUTH="false"
          UPDATE_CLAIM="false"
          UPDATE_GATEWAY="false"
          UPDATE_DISCOVERY="false"
          UPDATE_FRONTEND="false"

          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
             echo "Manual trigger: Updating ALL."
             UPDATE_AUTH="true"
             UPDATE_CLAIM="true"
             UPDATE_GATEWAY="true"
             UPDATE_DISCOVERY="true"
             UPDATE_FRONTEND="true"
          else
             # Check each folder explicitly from root
             if ! git diff --quiet HEAD^ HEAD -- backend/auth-service; then UPDATE_AUTH="true"; fi
             if ! git diff --quiet HEAD^ HEAD -- backend/claim-service; then UPDATE_CLAIM="true"; fi
             if ! git diff --quiet HEAD^ HEAD -- backend/api-gateway; then UPDATE_GATEWAY="true"; fi
             if ! git diff --quiet HEAD^ HEAD -- backend/discovery-service; then UPDATE_DISCOVERY="true"; fi
             if ! git diff --quiet HEAD^ HEAD -- frontend; then UPDATE_FRONTEND="true"; fi
          fi

          # 3. Move to Helm folder and Apply Updates
          cd helm/ucrmp

          if [ "$UPDATE_AUTH" == "true" ]; then
             sed -i "s|auth: .*|auth: \"sushantc041/ucrmp-auth:$SHORT_SHA\"|g" values.yaml
          fi
          
          if [ "$UPDATE_CLAIM" == "true" ]; then
             sed -i "s|claim: .*|claim: \"sushantc041/ucrmp-claim:$SHORT_SHA\"|g" values.yaml
          fi

          if [ "$UPDATE_GATEWAY" == "true" ]; then
             sed -i "s|gateway: .*|gateway: \"sushantc041/ucrmp-gateway:$SHORT_SHA\"|g" values.yaml
          fi

          if [ "$UPDATE_DISCOVERY" == "true" ]; then
             sed -i "s|discovery: .*|discovery: \"sushantc041/ucrmp-discovery-service:$SHORT_SHA\"|g" values.yaml
          fi

          if [ "$UPDATE_FRONTEND" == "true" ]; then
             sed -i "s|frontend: .*|frontend: \"sushantc041/ucrmp-frontend:$SHORT_SHA\"|g" values.yaml
          fi

          # Debug: Show file content
          cat values.yaml

      - name: Commit and Push
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          
          if git diff --quiet helm/ucrmp/values.yaml; then
            echo "No changes to values.yaml"
          else
            git add helm/ucrmp/values.yaml
            git commit -m "chore: update image tags [skip ci]"
            git push
          fi
