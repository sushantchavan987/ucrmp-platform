name: UCRMP CI Pipeline

on:
  # 1. ALLOW MANUAL TRIGGER (The Fix)
  workflow_dispatch:

  # 2. TRIGGER ON PUSH
  push:
    branches: [ "main" ]
    paths:
      - 'auth-service/**'
      - 'claim-service/**'
      - 'ucrmp-frontend/**'
      - 'api-gateway/**'
      - 'discovery-service/**'

# 3. PERMISSIONS (Required to push back to repo)
permissions:
  contents: write

jobs:
  # ====================================================
  # JOB 1: BUILD & PUSH (Matrix Strategy)
  # ====================================================
  build-and-push:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - service: auth
            context: ./auth-service
            image: sushantc041/ucrmp-auth
          - service: claim
            context: ./claim-service
            image: sushantc041/ucrmp-claim
          - service: frontend
            context: ./ucrmp-frontend
            image: sushantc041/ucrmp-frontend
          - service: gateway
            context: ./api-gateway
            image: sushantc041/ucrmp-gateway
          - service: discovery
            context: ./discovery-service
            image: sushantc041/ucrmp-discovery-service

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          fetch-depth: 2 

      # SMART CHANGE DETECTION
      - name: Check for changes
        id: changes
        run: |
          # If triggered manually, force build ALL services
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Manual trigger detected. Building ${{ matrix.service }}..."
          # Otherwise check git diff
          elif git diff --quiet HEAD^ HEAD -- ${{ matrix.context }}; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No changes in ${{ matrix.service }}. Skipping build."
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Changes detected in ${{ matrix.service }}. Proceeding..."
          fi

      - name: Login to Docker Hub
        if: steps.changes.outputs.changed == 'true'
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Generate Short SHA
        if: steps.changes.outputs.changed == 'true'
        id: vars
        run: echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Build and Push Docker Image
        if: steps.changes.outputs.changed == 'true'
        uses: docker/build-push-action@v4
        with:
          context: ${{ matrix.context }}
          push: true
          tags: |
            ${{ matrix.image }}:latest
            ${{ matrix.image }}:${{ steps.vars.outputs.sha_short }}

  # ====================================================
  # JOB 2: UPDATE HELM (Run only after builds finish)
  # ====================================================
  update-helm:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          fetch-depth: 2

      - name: Generate Short SHA
        id: vars
        run: echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Update values.yaml
        run: |
          cd helm/ucrmp
          SHORT_SHA=${{ steps.vars.outputs.sha_short }}
          
          # If manual trigger, update ALL tags. Otherwise check diff.
          FORCE_UPDATE="false"
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
             FORCE_UPDATE="true"
          fi

          for service in auth-service claim-service ucrmp-frontend api-gateway discovery-service; do
             if [ "$FORCE_UPDATE" == "true" ] || ! git diff --quiet HEAD^ HEAD -- ../../$service; then
               echo "Updating $service tag to $SHORT_SHA"
               if [ "$service" == "auth-service" ]; then 
                  sed -i "s|auth: .*|auth: \"sushantc041/ucrmp-auth:$SHORT_SHA\"|g" values.yaml
               elif [ "$service" == "claim-service" ]; then
                  sed -i "s|claim: .*|claim: \"sushantc041/ucrmp-claim:$SHORT_SHA\"|g" values.yaml
               elif [ "$service" == "ucrmp-frontend" ]; then
                  sed -i "s|frontend: .*|frontend: \"sushantc041/ucrmp-frontend:$SHORT_SHA\"|g" values.yaml
               elif [ "$service" == "api-gateway" ]; then
                  sed -i "s|gateway: .*|gateway: \"sushantc041/ucrmp-gateway:$SHORT_SHA\"|g" values.yaml
               elif [ "$service" == "discovery-service" ]; then
                  sed -i "s|discovery: .*|discovery: \"sushantc041/ucrmp-discovery-service:$SHORT_SHA\"|g" values.yaml
               fi
             fi
          done
          cat values.yaml 

      - name: Commit and Push
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          
          if git diff --quiet helm/ucrmp/values.yaml; then
            echo "No changes to values.yaml"
          else
            git add helm/ucrmp/values.yaml
            git commit -m "chore: update image tags for ${{ steps.vars.outputs.sha_short }} [skip ci]"
            git push
          fi